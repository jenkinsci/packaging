#!/bin/bash

set -x

VERSION=2.229

if hostname --all-ip-addresses | grep -q -F 172.16.16; then

  # markwaite.net
  PKG[debian]=https://home.markwaite.net/~mwaite/jenkins-builds/${VERSION}/jenkins-${VERSION}_all.deb
  PKG[msi]=https://home.markwaite.net/~mwaite/jenkins-builds/${VERSION}/jenkins-${VERSION}.zip
  PKG[suse]=https://home.markwaite.net/~mwaite/jenkins-builds/${VERSION}/jenkins-${VERSION}-1.2.noarch.rpm
  PKG[war]=https://home.markwaite.net/~mwaite/jenkins-builds/${VERSION}/jenkins-${VERSION}.war

else

  # everywhere else
  PKG[debian]=https://pkg.jenkins.io/debian/binary/jenkins_${VERSION}_all.deb
  PKG[msi]=http://mirrors.jenkins-ci.org/windows/jenkins-${VERSION}.zip
  PKG[suse]=https://pkg.jenkins.io/opensuse/jenkins-${VERSION}-1.2.noarch.rpm
  PKG[war]=http://mirrors.jenkins-ci.org/war/${VERSION}/jenkins.war

fi

[ -d results ] && rm -rf results

[ -d target ] || mkdir target

[ -d target/debian ] || mkdir target/debian
if ! ls target/debian/* > /dev/null 2>&1; then
    ( cd target/debian && wget ${PKG[debian]} )
fi

[ -d target/msi ] || mkdir target/msi
if ! ls target/msi/* > /dev/null 2>&1; then
    ( cd target/msi && wget ${PKG[msi]} && unzip *.zip )
fi

[ -d target/suse ] || mkdir target/suse
if ! ls target/suse/* > /dev/null 2>&1; then
    ( cd target/suse && wget ${PKG[suse]} )
fi

[ -d target/war ] || mkdir target/war
if ! ls target/war/* > /dev/null 2>&1; then
    ( cd target/war && wget ${PKG[war]} )
fi

WAR=target/war/*.war MSI=target/msi/*.msi make clean docker.images

installtests/run_tests.sh
